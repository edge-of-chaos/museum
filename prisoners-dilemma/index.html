<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¤¾ä¼šæ€§ã®ç´”ç²‹çµŒé¨“ï¼šè¡Œç‚ºçš„ç›´è¦³ (Pure Experience of Sociality: Action-Intuition)</title>
    <!-- Tailwind CSS & Chart.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«å›ºå®š */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #0f172a; /* Slate-900 */
            color: #f1f5f9;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-touch-callout: none;
            user-select: none;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .control-panel::-webkit-scrollbar { width: 4px; }
        .control-panel::-webkit-scrollbar-track { background: transparent; }
        .control-panel::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 10px; }

        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã®é«˜ã•å›ºå®š */
        #chart-wrapper {
            height: 140px;
            width: 100%;
            flex-shrink: 0;
            margin-top: auto;
        }

        /* ãƒã‚ªãƒ³ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            margin-top: -6px;
            border: 2px solid #475569;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
        /* æˆ¦ç•¥ã‚«ãƒ©ãƒ¼åŒæœŸ */
        .slider-coop::-webkit-slider-thumb { background: #FFFFFF; }
        .slider-defect::-webkit-slider-thumb { background: #000000; }
        .slider-tft::-webkit-slider-thumb { background: #4299e1; }
        .slider-grim::-webkit-slider-thumb { background: #9b59b6; }
        .slider-tftt::-webkit-slider-thumb { background: #1abc9c; }
        .slider-pavlov::-webkit-slider-thumb { background: #e67e22; }
        .slider-disposition::-webkit-slider-thumb { background: #a0aec0; }
        .slider-appraiser::-webkit-slider-thumb { background: #ffff00; }
        .slider-sect::-webkit-slider-thumb { background: #ff00ff; }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆä¸Šä¸‹50%ï¼‰ */
        @media (max-width: 1023px) {
            #canvas-container {
                height: 50vh;
                width: 100vw;
            }
            aside {
                height: 50vh;
            }
        }

/* â‘¢ãµã‚ã£ã¨å‡ºã™ãŸã‚ã®è¨­å®š */
#infoPanel.opacity-100 { opacity: 1; }
#infoPanel { transition: opacity 0.5s ease; }        
    </style>
</head>
<body class="flex flex-col lg:flex-row w-full h-screen overflow-hidden">

    <!-- æå†™é ˜åŸŸ (Visualization) -->
    <main id="canvas-container" class="flex-shrink-0 lg:flex-grow flex justify-center items-center bg-black/60 relative p-1 lg:p-6">
        <canvas id="gridCanvas" class="shadow-2xl bg-slate-800 rounded-lg transition-opacity duration-300"></canvas>
    </main>

    <!-- æ“ä½œãƒ‘ãƒãƒ« (Dashboard) -->
    <aside class="w-full lg:w-[320px] xl:w-[380px] flex-shrink-0 bg-slate-900 border-t lg:border-t-0 lg:border-l border-slate-800 flex flex-col h-full overflow-hidden shadow-2xl z-10">
        <div class="control-panel p-4 lg:p-6 overflow-y-auto flex-grow flex flex-col gap-5">
            
            <header class="text-center">
                <h1 class="text-xl font-black text-white tracking-tighter italic uppercase border-b border-slate-700 pb-2">
                    ç¤¾ä¼šæ€§ã®ç´”ç²‹çµŒé¨“ <span class="text-xs opacity-40 font-normal italic text-blue-400">Action-Intuition</span>
                </h1>
                <p class="text-[9px] text-slate-500 font-bold tracking-widest mt-1 uppercase">Exhibit 02-A: Pure Experience of Sociality</p>
                
                <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="grid grid-cols-3 gap-1 mt-4 p-2 bg-slate-800/40 rounded border border-slate-700/50 text-[8px] uppercase font-bold text-slate-400">
                    <div class="flex flex-col border-r border-slate-700/50"><span>å”åŠ›åº¦</span><span id="cooperationRateDisplay" class="text-teal-400 text-sm font-black">50%</span></div>
                    <div class="flex flex-col border-r border-slate-700/50"><span>å¤šæ§˜æ€§æŒ‡æ•°</span><span id="diversityIndexDisplay" class="text-fuchsia-400 text-sm font-black">0%</span></div>
                    <div class="flex flex-col"><span>åˆ©å¾—(R)</span><span id="rewardDisplay" class="text-green-500 text-sm font-mono">3.0</span></div>
                    <div class="flex flex-col border-t border-r border-slate-700/50 mt-1 pt-1"><span>èª˜æƒ‘(T)</span><span id="temptationDisplay" class="text-red-500 text-sm font-mono">5.0</span></div>
                    <div class="flex flex-col border-t border-r border-slate-700/50 mt-1 pt-1"><span>å ±ã„(S)</span><span id="suckerDisplay" class="text-blue-500 text-sm font-mono">0.0</span></div>
                    <div class="flex flex-col border-t border-slate-700/50 mt-1 pt-1"><span>ä¸–ä»£</span><span id="generationDisplay" class="text-slate-300 text-sm font-mono">0</span></div>
                </div>
            </header>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="grid grid-cols-3 gap-2 shrink-0">
                <button id="startStopBtn" class="bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-black py-2.5 rounded-lg text-[10px] transition-all shadow-lg uppercase tracking-tight">é–‹å§‹ (START)</button>
                <button id="resetBtn" class="bg-emerald-700 hover:bg-emerald-600 active:scale-95 text-white font-black py-2.5 rounded-lg text-[10px] transition-all shadow-lg uppercase tracking-tight">åˆæœŸåŒ– (RESET)</button>
                <button id="stepBtn" class="bg-slate-700 hover:bg-slate-600 active:scale-95 text-white font-black py-2.5 rounded-lg text-[10px] transition-all shadow-lg uppercase tracking-tight">1æ­© (STEP)</button>
            </div>

            <!-- ç’°å¢ƒè¨­å®šï¼šé †åºæœ€é©åŒ– (çªç„¶å¤‰ç•°ç‡ â†’ æ…ˆæ‚²çš„ä»‹å…¥ â†’ æ›´æ–°é€Ÿåº¦ â†’ ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º) -->
            <section class="space-y-4 bg-slate-800/20 p-4 rounded-xl border border-slate-700/30 shadow-inner">
                <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest pl-1 border-l-2 border-slate-600">ç’°å¢ƒè¨­å®š (Environment)</h2>
                <div class="space-y-4">
                    <div class="group">
                        <label class="flex justify-between text-[10px] font-bold text-slate-400 mb-1">
                            çªç„¶å¤‰ç•°ç‡ (MUTATION) <span id="mutationLabel" class="text-white">1/65536</span>
                        </label>
                        <input id="mutationSlider" type="range" min="0" max="17" value="1">
                    </div>
                    <div class="group">
                        <label class="flex justify-between text-[10px] font-bold text-slate-400 mb-1">
                            æ…ˆæ‚²çš„ä»‹å…¥ (MOOD) <span id="moodLabel" class="text-white">0.0</span>
                        </label>
                        <input id="moodSlider" type="range" min="0" max="3" step="0.1" value="0">
                    </div>
                    <div class="group">
                        <label class="flex justify-between text-[10px] font-bold text-slate-400 mb-1">
                            æ›´æ–°é€Ÿåº¦ (SPEED) <span id="speedLabel" class="text-white font-bold">æ¨™æº– (Standard)</span>
                        </label>
                        <input id="speedSlider" type="range" min="0" max="500" value="250">
                    </div>
                    <div class="group pt-2 border-t border-slate-800/50">
                        <label class="flex justify-between text-[10px] font-bold text-slate-500 mb-1">
                            ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º (GRID SIZE) <span id="gridSizeLabel" class="text-slate-400">128</span>
                        </label>
                        <input id="gridSizeSlider" type="range" min="10" max="256" value="128">
                    </div>
                </div>
            </section>
            
            <!-- æˆ¦ç•¥æ¯”ç‡è¨­å®š -->
            <section class="space-y-3">
                <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest pl-1 border-l-2 border-blue-500">ä½æ°‘ã®åˆ†å¸ƒ (Weights)</h2>
                <div class="grid grid-cols-1 gap-3 px-1 pb-4">
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-slate-300"><span>å”åŠ› (COOP)</span><span id="coopRatioLabel" class="text-slate-500">5%</span></div>
                        <input id="coopSlider" type="range" min="0" max="100" value="5" class="slider-coop">
                    </div>
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-slate-300"><span>è£åˆ‡ã‚Š (DEFECT)</span><span id="defectRatioLabel" class="text-slate-500">10%</span></div>
                        <input id="defectSlider" type="range" min="0" max="100" value="10" class="slider-defect">
                    </div>
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-blue-400"><span>ã—ã£ãºè¿”ã— (TFT)</span><span id="tftRatioLabel" class="text-slate-500">10%</span></div>
                        <input id="tftSlider" type="range" min="0" max="100" value="10" class="slider-tft">
                    </div>
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-purple-400"><span>å¼•é‡‘ (GRIM)</span><span id="grimRatioLabel" class="text-slate-500">5%</span></div>
                        <input id="grimSlider" type="range" min="0" max="100" value="5" class="slider-grim">
                    </div>
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-teal-400"><span>ã—ã£ãºè¿”ã—è¿”ã— (TFTT)</span><span id="tfttRatioLabel" class="text-slate-500">5%</span></div>
                        <input id="tfttSlider" type="range" min="0" max="100" value="5" class="slider-tftt">
                    </div>
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-orange-400"><span>ãƒ‘ãƒ–ãƒ­ãƒ• (PAVLOV)</span><span id="pavlovRatioLabel" class="text-slate-500">10%</span></div>
                        <input id="pavlovSlider" type="range" min="0" max="100" value="10" class="slider-pavlov">
                    </div>
                    <div class="space-y-1 text-[10px] font-bold">
                        <div class="flex justify-between text-slate-400"><span>æ°—è³ª (DISPOSITION)</span><span id="randRatioLabel" class="text-slate-500">15%</span></div>
                        <input id="randSlider" type="range" min="0" max="100" value="15" class="slider-disposition">
                    </div>
                    <div class="space-y-1 bg-yellow-400/5 p-1 rounded border border-yellow-400/10 text-[10px] font-black">
                        <div class="flex justify-between text-yellow-400"><span>é‘‘å®šå£« (APPRAISER)</span><span id="appraiserRatioLabel" class="text-slate-500 font-normal">25%</span></div>
                        <input id="appraiserSlider" type="range" min="0" max="100" value="25" class="slider-appraiser">
                    </div>
                    <div class="space-y-1 bg-pink-500/5 p-1 rounded border border-pink-500/10 text-[10px] font-black">
                        <div class="flex justify-between text-pink-500"><span>å®—æ´¾ (SECT)</span><span id="sectRatioLabel" class="text-slate-500 font-normal">15%</span></div>
                        <input id="sectSlider" type="range" min="0" max="100" value="15" class="slider-sect">
                    </div>
                </div>
            </section>

            <!-- ã‚°ãƒ©ãƒ• -->
            <div id="chart-wrapper" class="bg-black/40 rounded-xl border border-slate-800 p-2 shrink-0 mb-4 shadow-2xl">
                <canvas id="populationChart"></canvas>
            </div>
            
            <footer class="text-[8px] text-center text-slate-700 font-bold uppercase tracking-[0.3em] shrink-0 mb-2 italic">
                Absolute Contradiction & Co-evolution
            </footer>
        </div>
    </aside>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ã‚·ã‚¹ãƒ†ãƒ ã‚³ã‚¢å®šæ•° ---
    const STRATEGIES = { COOP: 0, DEFECT: 1, TFT: 2, GRIM: 3, TFTT: 4, PAVLOV: 5, DISPOSITION: 6, APPRAISER: 7, SECT: 8 };
    const COLORS = {
        [STRATEGIES.COOP]: '#FFFFFF', [STRATEGIES.DEFECT]: '#000000', [STRATEGIES.TFT]: '#4299e1',
        [STRATEGIES.GRIM]: '#9b59b6', [STRATEGIES.TFTT]: '#1abc9c', [STRATEGIES.PAVLOV]: '#e67e22',
        [STRATEGIES.DISPOSITION]: '#808080', [STRATEGIES.APPRAISER]: '#ffff00', [STRATEGIES.SECT]: '#ff00ff',
    };
    const STRATEGY_NAMES = {
        [STRATEGIES.COOP]: 'å”åŠ› (COOP)', [STRATEGIES.DEFECT]: 'è£åˆ‡ã‚Š (DEF)', [STRATEGIES.TFT]: 'ã—ã£ãºè¿”ã— (TFT)',
        [STRATEGIES.GRIM]: 'å¼•é‡‘ (GRIM)', [STRATEGIES.TFTT]: 'è¿”è¿” (TFTT)', [STRATEGIES.PAVLOV]: 'ãƒ‘ãƒ–ãƒ­ãƒ• (PAV)',
        [STRATEGIES.DISPOSITION]: 'æ°—è³ª (DISPOSITION)', [STRATEGIES.APPRAISER]: 'é‘‘å®šå£« (APPRAISER)', [STRATEGIES.SECT]: 'å®—æ´¾ (SECT)',
    };

    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    const ui = {
        startStop: document.getElementById('startStopBtn'),
        reset: document.getElementById('resetBtn'),
        step: document.getElementById('stepBtn'),
        gridSize: document.getElementById('gridSizeSlider'),
        gridLabel: document.getElementById('gridSizeLabel'),
        mutation: document.getElementById('mutationSlider'),
        mutationLabel: document.getElementById('mutationLabel'),
        speed: document.getElementById('speedSlider'),
        speedLabel: document.getElementById('speedLabel'),
        mood: document.getElementById('moodSlider'),
        moodLabel: document.getElementById('moodLabel'),
        coopDisp: document.getElementById('cooperationRateDisplay'),
        diversityDisp: document.getElementById('diversityIndexDisplay'),
        genDisp: document.getElementById('generationDisplay'),
        rDisp: document.getElementById('rewardDisplay'),
        tDisp: document.getElementById('temptationDisplay'),
        sDisp: document.getElementById('suckerDisplay')
    };

    const sSliders = {
        coop: document.getElementById('coopSlider'), defect: document.getElementById('defectSlider'),
        tft: document.getElementById('tftSlider'), grim: document.getElementById('grimSlider'),
        tftt: document.getElementById('tfttSlider'), pavlov: document.getElementById('pavlovSlider'),
        rand: document.getElementById('randSlider'), appraiser: document.getElementById('appraiserSlider'),
        sect: document.getElementById('sectSlider')
    };
    const sLabels = {};
    for (let k in sSliders) sLabels[k] = document.getElementById(k + 'RatioLabel');

    // --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ ---
    let gridSize = 128, mutationRate = 1 / 65536, interval = 80, moodEffectStrength = 0;
    let grid = null, prevA = null, prevPrevA = null, memoryG = null, memoryA = null, memoryS = null;
    let isRunning = false, animationId = null, lastTime = 0, gen = 0;
    let curPayoffs = { R: 3, T: 5, S: 0, P: 1 };

    const BASE_COOP_RATE = 0.75, SECT_TOLERANCE = 2, FORGIVENESS = 5;
    const HANDSHAKE_S = [0, 0, 1], HANDSHAKE_E = [0, 0, 1]; 
    // ã€é‡è¦ã€‘å¾®ç´°ç¶™æ‰¿ã®è¨­å®šï¼š128åˆ†ã®1
    const RAND_MUT_STEP = 1/128; 

    // --- Chart.js ---
    let chart;
    function buildChart() {
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('populationChart').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: Object.keys(STRATEGIES).map(k => ({ label: STRATEGY_NAMES[STRATEGIES[k]], data: [], borderColor: COLORS[STRATEGIES[k]], borderWidth: 1.5, pointRadius: 0, tension: 0.15 })) },
            options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { beginAtZero: true, grid: { color: '#1e293b' }, ticks: { color: '#475569', font: { size: 8 } } } }
            }
        });
    }

    function getNeighbors(x, y) {
        const n = [];
        for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
                if (dx === 0 && dy === 0) continue;
                n.push({ x: (x + dx + gridSize) % gridSize, y: (y + dy + gridSize) % gridSize });
            }
        }
        return n;
    }

    // ã€è¡Œç‚ºçš„ç›´è¦³ï¼šå€‹åˆ¥åå¿œã€‘ãƒ™ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®é¢ç™½ã•ã‚’ç¶­æŒ
    function getAct(cell, x, y, ox, oy) {
        const s = cell.strategy, id = `${ox},${oy}`;
        switch (s) {
            case STRATEGIES.COOP: return 0;
            case STRATEGIES.DEFECT: return 1;
            case STRATEGIES.TFT: return prevA[oy][ox];
            case STRATEGIES.GRIM: return memoryG[y][x].has(id) ? 1 : 0;
            case STRATEGIES.TFTT: return (prevA[oy][ox] === 1 && prevPrevA[oy][ox] === 1) ? 1 : 0;
            case STRATEGIES.PAVLOV: return (prevA[y][x] === prevA[oy][ox]) ? 0 : 1;
            case STRATEGIES.DISPOSITION: return Math.random() < cell.coopRate ? 0 : 1;
            case STRATEGIES.APPRAISER: {
                let m = memoryA[y][x]; if (!m[id]) m[id] = { s: 0 };
                m[id].s = Math.max(-10, Math.min(10, m[id].s + (prevA[oy][ox] === 0 ? 1 : -1)));
                return m[id].s > 2 ? 0 : (m[id].s < -2 ? 1 : prevA[oy][ox]);
            }
            case STRATEGIES.SECT: {
                let m = memoryS[y][x]; if (!m[id]) m[id] = { turn: 0, h: [], st: 'p', b: 0, sk: 0 };
                const c = m[id]; if (c.st === 'ally') return 0; if (c.st === 'enemy') return c.b >= SECT_TOLERANCE ? 1 : 0;
                if (c.turn < HANDSHAKE_S.length) return HANDSHAKE_S[c.turn];
                let match = true; for(let i=0; i<HANDSHAKE_E.length; i++) if(c.h[i] !== HANDSHAKE_E[i]) match = false;
                c.st = match ? 'ally' : 'enemy'; return match ? 0 : (c.b >= SECT_TOLERANCE ? 1 : 0);
            }
        }
    }

    function syncPayoffs(rate) {
        const f = (rate - 0.5) * 2;
        if (f < 0) { curPayoffs.R = 3.0 - (f * moodEffectStrength * 1.5); curPayoffs.T = 5.0 + (f * moodEffectStrength); curPayoffs.S = 0; }
        else { curPayoffs.R = 3.0 + (f * moodEffectStrength * 0.5); curPayoffs.T = 5.0; curPayoffs.S = (f * moodEffectStrength * 0.5); }
        ui.rDisp.textContent = curPayoffs.R.toFixed(1); ui.tDisp.textContent = curPayoffs.T.toFixed(1); ui.sDisp.textContent = curPayoffs.S.toFixed(1);
    }

    function processEvolve() {
        if (!prevA) return;
        const nextA = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));
        const scores = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));
        const counts = Array(9).fill(0);
        let totalC = 0;

        for (let y=0; y<gridSize; y++) {
            for (let x=0; x<gridSize; x++) {
                if(prevA[y][x] === 0) totalC++;
                counts[grid[y][x].strategy]++;
            }
        }

        const totalCells = gridSize * gridSize;
        let entropy = 0;
        counts.forEach(c => { if(c > 0) { let p = c/totalCells; entropy -= p * Math.log2(p); } });
        ui.diversityDisp.textContent = `${Math.round((entropy / Math.log2(9)) * 100)}%`;
        ui.coopDisp.textContent = `${Math.round((totalC/totalCells) * 100)}%`;
        ui.genDisp.textContent = gen;

        // ã‚¹ãƒ†ãƒƒãƒ—1: åˆ©å¾—è¨ˆç®—
        for (let y=0; y<gridSize; y++) {
            for (let x=0; x<gridSize; x++) {
                const ns = getNeighbors(x, y); let scoreSum = 0, sumA = 0;
                for (const n of ns) {
                    const myA = getAct(grid[y][x], x, y, n.x, n.y), opA = getAct(grid[n.y][n.x], n.x, n.y, x, y);
                    scoreSum += (myA === 0) ? (opA === 0 ? curPayoffs.R : curPayoffs.S) : (opA === 0 ? curPayoffs.T : curPayoffs.P);
                    sumA += myA;
                    if (grid[y][x].strategy === STRATEGIES.GRIM && opA === 1) memoryG[y][x].add(`${n.x},${n.y}`);
                    if (grid[y][x].strategy === STRATEGIES.SECT) {
                        let m = memoryS[y][x][`${n.x},${n.y}`];
                        if (m.st === 'p') { m.h.push(opA); m.turn++; }
                        else if (m.st === 'enemy') { if (opA === 1) { m.b++; m.sk = 0; } else { m.sk++; if(m.sk >= FORGIVENESS && m.b > 0) { m.b--; m.sk = 0; } } }
                    }
                }
                scores[y][x] = scoreSum; nextA[y][x] = (sumA / ns.length) > 0.5 ? 1 : 0;
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—2: é€²åŒ– (ã€é‡è¦ã€‘æœ‰æ©Ÿçš„ç­‰æ–¹æ€§ã®ç¢ºä¿)
        const nextGrid = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));
        const mPool = [];
        for (let k in sSliders) { let w = parseInt(sSliders[k].value), s = STRATEGIES[k.toUpperCase() === 'RAND' ? 'DISPOSITION' : k.toUpperCase()]; for (let i=0; i<w; i++) mPool.push(s); }
        if (mPool.length === 0) mPool.push(...Object.values(STRATEGIES));

        for (let y = 0; y < gridSize; y++) {
            for (let x = 0; x < gridSize; x++) {
                const ns = getNeighbors(x, y);
                let maxS = scores[y][x];
                let winners = [{y, x}]; // è‡ªåˆ†ã‚’åˆæœŸå€™è£œã«
                
                ns.forEach(n => {
                    if (scores[n.y][n.x] > maxS) {
                        maxS = scores[n.y][n.x];
                        winners = [{y: n.y, x: n.x}];
                    } else if (scores[n.y][n.x] === maxS) {
                        winners.push({y: n.y, x: n.x});
                    }
                });

                // ã€æ­¢æšï¼šç­‰æ–¹æ€§ã®ç¢ºä¿ã€‘ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ³ã‚°
                const w = winners[Math.floor(Math.random() * winners.length)];
                let nextCell = { ...grid[w.y][w.x] };

                // çªç„¶å¤‰ç•°
                if (Math.random() < mutationRate) {
                    const st = mPool[Math.floor(Math.random() * mPool.length)];
                    nextCell = { strategy: st, coopRate: Math.random() };
                } else if (nextCell.strategy === STRATEGIES.DISPOSITION) {
                    // ã€æ­¢æšï¼šå¾®ç´°ç¶™æ‰¿ã€‘128åˆ†ã®1ã®ã‚†ã‚‰ã
                    nextCell.coopRate = Math.max(0, Math.min(1, nextCell.coopRate + (Math.random()-0.5) * RAND_MUT_STEP));
                }

                // äº¤ä»£æ™‚ã«è¨˜æ†¶ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (grid[y][x].strategy !== nextCell.strategy) {
                    memoryG[y][x].clear(); memoryA[y][x] = {}; memoryS[y][x] = {};
                }
                nextGrid[y][x] = nextCell;
            }
        }

        grid = nextGrid; prevPrevA = prevA; prevA = nextA; gen++;
    }

    function render() {
        if (!grid) return;
        const s = canvas.width / gridSize;
        ctx.fillStyle = '#1e293b'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (let y=0; y<gridSize; y++) {
            for (let x=0; x<gridSize; x++) {
                const c = grid[y][x];
                if (c.strategy === STRATEGIES.DISPOSITION) {
                    const g = Math.round(255 * c.coopRate); ctx.fillStyle = `rgb(${g},${g},${g})`;
                } else ctx.fillStyle = COLORS[c.strategy];
                ctx.fillRect(Math.floor(x * s), Math.floor(y * s), Math.ceil(s), Math.ceil(s));
            }
        }
    }

    function updateChart() {
        if (!chart) return;
        const counts = Array(9).fill(0);
        for (let y=0; y<gridSize; y++) for (let x=0; x<gridSize; x++) counts[grid[y][x].strategy]++;
        if (chart.data.labels.length > 50) { chart.data.labels.shift(); chart.data.datasets.forEach(d => d.data.shift()); }
        chart.data.labels.push(gen); chart.data.datasets.forEach((d, i) => d.data.push(counts[i])); chart.update('none');
    }

    function loop(t) {
        if (!isRunning) return; animationId = requestAnimationFrame(loop);
        if (t - lastTime > interval) { processEvolve(); render(); updateChart(); lastTime = t; }
    }

    function fit() {
        const container = document.getElementById('canvas-container');
        const rect = container.getBoundingClientRect();
        const size = Math.min(rect.width, rect.height) - 10;
        canvas.width = canvas.height = size;
        render();
    }

    function getM(v) { return v == 0 ? 0 : (v == 17 ? 1 : 1 / Math.pow(2, 17 - v)); }
    function calcIntervalAndLabel(v) {
        let iv = 80; let lb = "æ¨™æº– (Standard)";
        if (v >= 250) { iv = 80 - ((v - 250) * (70 / 250)); if (v > 450) lb = "çˆ†é€Ÿ (Extreme)"; else if (v > 300) lb = "é«˜é€Ÿ (High)"; }
        else { iv = 500 - (v * (420 / 250)); if (v < 50) lb = "ä½é€Ÿ (Slow)"; else if (v < 200) lb = "ã‚„ã‚„ä½é€Ÿ (Low)"; }
        return { interval: iv, label: lb };
    }

    function reset() {
        isRunning = false; ui.startStop.textContent = 'é–‹å§‹ (START)'; gen = 0;
        cancelAnimationFrame(animationId);
        gridSize = parseInt(ui.gridSize.value); 
        mutationRate = getM(parseInt(ui.mutation.value));
        const sp = calcIntervalAndLabel(parseInt(ui.speed.value));
        interval = sp.interval; ui.speedLabel.textContent = sp.label;
        moodEffectStrength = parseFloat(ui.mood.value);

        const totalW = Object.values(sSliders).reduce((a, b) => a + parseInt(b.value), 0);
        const pool = []; const target = gridSize * gridSize;
        for (let k in sSliders) {
            let n = Math.round((parseInt(sSliders[k].value) / (totalW || 1)) * target);
            let st = STRATEGIES[k.toUpperCase() === 'RAND' ? 'DISPOSITION' : k.toUpperCase()];
            for (let i = 0; i < n; i++) pool.push({ strategy: st, coopRate: Math.random() });
        }
        while(pool.length < target) pool.push({ strategy: STRATEGIES.COOP, coopRate: Math.random() });
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1)); [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        
        grid = Array(gridSize).fill(0).map((_, y) => Array(gridSize).fill(0).map((_, x) => pool[y * gridSize + x]));
        const randX = () => Math.random() < 0.5 ? 0 : 1;
        prevA = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0).map(randX));
        prevPrevA = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0).map(randX));
        memoryG = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0).map(() => new Set()));
        memoryA = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0).map(() => ({})));
        memoryS = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0).map(() => ({})));

        fit(); buildChart(); updateChart();
        ui.genDisp.textContent = 0; ui.coopDisp.textContent = "50%"; ui.diversityDisp.textContent = "100%";
    }

    ui.startStop.onclick = () => { isRunning = !isRunning; ui.startStop.textContent = isRunning ? 'åœæ­¢ (STOP)' : 'å†é–‹ (RESUME)'; if (isRunning) { lastTime = performance.now(); loop(lastTime); } };
    ui.reset.onclick = reset; ui.step.onclick = () => { if(isRunning) return; processEvolve(); render(); updateChart(); };
    ui.gridSize.oninput = e => ui.gridLabel.textContent = e.target.value; ui.gridSize.onchange = reset;
    ui.mutation.oninput = e => { const v = parseInt(e.target.value); mutationRate = getM(v); ui.mutationLabel.textContent = v === 0 ? '0' : (v === 17 ? '100%' : `1/${Math.pow(2, 17-v)}`); };
    ui.speed.oninput = e => { 
        const v = parseInt(e.target.value);
        const sp = calcIntervalAndLabel(v); interval = sp.interval; ui.speedLabel.textContent = sp.label;
    };
    ui.mood.oninput = e => { moodEffectStrength = parseFloat(e.target.value); ui.moodLabel.textContent = e.target.value; };
    function norm() { let t = 0; for(let k in sSliders) t += parseInt(sSliders[k].value); for(let k in sSliders) sLabels[k].textContent = t === 0 ? '0%' : `${Math.round((parseInt(sSliders[k].value)/t)*100)}%`; }
    for(let k in sSliders) sSliders[k].oninput = norm;
    window.addEventListener('resize', fit); reset(); norm();
});
</script>
<button id="infoOpenBtn" class="fixed top-4 right-4 z-50 bg-slate-800/80 hover:bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center border border-slate-700 shadow-xl transition-all active:scale-90">
        <span class="font-serif italic text-lg text-blue-400">i</span>
    </button>

    <div id="infoPanel" class="fixed inset-0 z-[100] bg-slate-950/95 backdrop-blur-md overflow-y-auto hidden opacity-0 transition-opacity duration-500 p-6 lg:p-20">
        <div class="max-w-3xl mx-auto text-slate-300 font-serif leading-relaxed">
            <button id="infoCloseBtn" class="fixed top-8 right-8 text-slate-500 hover:text-white text-3xl">Ã—</button>
            <header class="mb-12 border-b border-slate-800 pb-8 text-center">
                <h2 class="text-3xl font-black text-white italic tracking-tighter mb-2">ç¤¾ä¼šæ€§ã®ç´”ç²‹çµŒé¨“ï¼šè¡Œç‚ºçš„ç›´è¦³</h2>
                <p class="text-xs tracking-[0.4em] text-blue-500 uppercase">Exhibit 02-A Archive</p>
            </header>
            <section class="space-y-12">
                <div>
                    <h3 class="text-xl font-bold text-white mb-6 border-l-4 border-blue-600 pl-4">1. å›šäººã®ã‚¸ãƒ¬ãƒ³ãƒï¼šå…±å‰µã®æ‘ã®ç‰©èª</h3>
                    <p class="mb-4 text-slate-400">ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ ¹æœ¬ã«ã‚ã‚‹ã®ã¯ã€å€‹ã€…ã®æœ€é©ãªé¸æŠãŒå…¨ä½“ã®èª¿å’Œã‚’æãªã†ã¨ã„ã†è‘›è—¤ã§ã™ã€‚</p>
                    <div class="bg-slate-900/50 p-6 rounded-lg border border-slate-800 italic text-sm space-y-4">
                        <p><strong>ã€çŠ¶æ³ã€‘</strong> ä½æ°‘ã¯è‡ªåˆ†ã®æŒã¤ã€Œç‹¬è‡ªã®çŸ¥æµã€ã‚’å…±æœ‰ã—ã€ã€ŒåŠ´åŠ›ã€ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
                        <ul class="list-disc pl-5 space-y-2 text-slate-500">
                            <li><strong class="text-slate-300">å ±é…¬ (R):</strong> äº’ã„ã®ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ãŒéŸ¿ãåˆã„ã€æ€¥é€Ÿã«ç™ºå±•ã™ã‚‹è±Šã‹ãªç”Ÿã€‚</li>
                            <li><strong class="text-slate-300">èª˜æƒ‘ (T):</strong> è‡ªåˆ†ã¯åŠ´åŠ›ã‚’æ¸©å­˜ã—ã€ç›¸æ‰‹ã®çŒ®èº«ã‚’ä¸€æ–¹çš„ã«äº«å—ã™ã‚‹ã€‚</li>
                            <li><strong class="text-slate-300">å–„æ„ã®æ¾å– (S):</strong> è‡ªåˆ†ã®çŒ®èº«ã‚’ç›¸æ‰‹ã«åˆ©ç”¨ã•ã‚Œã€å†ç”Ÿç”£ãŒå›°é›£ãªçŠ¶æ³ã€‚</li>
                            <li><strong class="text-slate-300">ç›¸äº’ä¸ä¿¡ (P):</strong> èª°ã‚‚çŸ¥æµã‚’å‡ºã•ãšã€ä¸–ç•ŒãŒè’å»ƒã—ãŸã¾ã¾å›ºå®šã•ã‚Œã‚‹ã€‚</li>
                        </ul>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white mb-6 border-l-4 border-blue-600 pl-4">2. æˆ¦ç•¥ï¼ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã®å®šç¾©</h3>
                    <div class="overflow-x-auto text-xs">
                        <table class="w-full text-left border-collapse border border-slate-800">
                            <tr class="bg-slate-900 text-blue-400">
                                <th class="p-2 border border-slate-800">æˆ¦ç•¥</th><th class="p-2 border border-slate-800">æ¦‚è¦</th><th class="p-2 border border-slate-800">ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </th>
                            </tr>
                            <tr><td class="p-2 border border-slate-800">å”åŠ›</td><td>ç´”ç²‹åˆ©ä»–</td><td>å¸¸ã«å”åŠ›(C)ã‚’é¸æŠã€‚</td></tr>
                            <tr><td class="p-2 border border-slate-800">è£åˆ‡ã‚Š</td><td>ç´”ç²‹åˆ©å·±</td><td>å¸¸ã«è£åˆ‡ã‚Š(D)ã‚’é¸æŠã€‚</td></tr>
                            <tr><td class="p-2 border border-slate-800">ã—ã£ãºè¿”ã—</td><td>äº’æµä¸»ç¾©</td><td>å‘¨å›²ã®å”åŠ›ç‡ãŒ50%ä»¥ä¸Šãªã‚‰Cã€æœªæº€ãªã‚‰Dã€‚</td></tr>
                            <tr><td class="p-2 border border-slate-800">å¼•é‡‘</td><td>æ–­ç½ªä¸»ç¾©</td><td>ä¸€åº¦ã§ã‚‚è£åˆ‡ã‚Šã‚’è¦³æ¸¬ã™ã‚Œã°æ°¸ä¹…ã«Dã€‚</td></tr>
                            <tr><td class="p-2 border border-slate-800 text-blue-400">é‘‘å®šå£«</td><td>çŸ¥æ€§åˆ†æ</td><td>éš£äººã®è¡Œå‹•ã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã€‚â€»è©³ç´°å‚ç…§</td></tr>
                        </table>
                    </div>
                </div>
                <div class="bg-blue-900/10 p-8 border-t-2 border-blue-900/50">
                    <h4 class="text-lg font-bold text-blue-400 mb-4 italic">ğŸ› ï¸ é‘‘å®šå£« (APPRAISER) ã®è©³ç´°</h4>
                    <p class="text-sm text-slate-400 mb-4">éš£äººã”ã¨ã«ä¿¡é ¼ã‚¹ã‚³ã‚¢ã‚’ $[-10, 10]$ ã§ä¿æŒã€‚å¹³å‡ä¿¡é ¼åº¦ãŒ $1$ ä»¥ä¸Šãªã‚‰ã€Œå”åŠ›ã€ã€$-1$ ä»¥ä¸‹ãªã‚‰ã€Œè£åˆ‡ã‚Šã€ã€ãã®ä¸­é–“ã§ã¯ã€Œå ´ã®ç©ºæ°—ã€ã«åŒèª¿ã—ã¾ã™ã€‚</p>
                </div>
            </section>
            <footer class="mt-20 py-10 border-t border-slate-900 text-center text-[10px] tracking-[0.4em] text-slate-700">ABSOLUTE CONTRADICTION & CO-EVOLUTION</footer>
        </div>
    </div>
    ```

#### ã‚¹ãƒ†ãƒƒãƒ—2ï¼šJavaScriptï¼ˆå‹•ã‹ã™ä»•çµ„ã¿ï¼‰ã‚’è²¼ã‚‹
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€å¾Œã®æ–¹ã«ã€**`window.addEventListener('resize', fit); reset(); norm();`** ã¨ã„ã†è¡ŒãŒã‚ã‚‹ã¯ãšã‚„ã€‚
ãã®**ã€Œæ¬¡ã€ã®è¡Œï¼ˆ `});` ã®ç›´å‰ï¼‰**ã«ã€ã“ã‚Œã‚’è²¼ã£ã¦ãªã€‚

```javascript
    // â‘¡ãƒ‘ãƒãƒ«ã‚’é–‹ã‘é–‰ã‚ã™ã‚‹ä»•çµ„ã¿ï¼ˆã“ã“ã‹ã‚‰ï¼‰
    const infoPanel = document.getElementById('infoPanel');
    const infoOpenBtn = document.getElementById('infoOpenBtn');
    const infoCloseBtn = document.getElementById('infoCloseBtn');

    infoOpenBtn.onclick = () => {
        infoPanel.classList.remove('hidden');
        setTimeout(() => infoPanel.classList.add('opacity-100'), 10);
    };

    infoCloseBtn.onclick = () => {
        infoPanel.classList.remove('opacity-100');
        setTimeout(() => infoPanel.classList.add('hidden'), 500);
    };
    // â‘¡ï¼ˆã“ã“ã¾ã§ï¼‰    
</body>
</html>
